<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure IntroHater</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">


    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">


    <link rel="stylesheet" href="css/style.css?v=7">
    <script src="js/toast.js" defer></script>
    <script src="js/main.js" defer></script>
</head>

<body>

    <header>
        <div class="container">
            <a href="index.html" class="logo text-gradient">
                <img src="icon.svg" alt="Logo">
                IntroHater
            </a>


            <button class="menu-toggle" aria-label="Toggle navigation menu" id="menuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <nav id="mainNav">
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="catalog.html">Catalog</a></li>
                    <li><a href="leaderboard.html">Leaderboard</a></li>
                    <li><a href="contribute.html">Contribute</a></li>
                    <li><a href="profile.html">Profile</a></li>
                    <li><a href="https://github.com/introhaterapp/IntroHater" target="_blank">GitHub</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <a href="configure.html" class="btn btn-primary btn-header-install active">Install Addon</a>
            </div>
        </div>
    </header>

    <main>
        <section class="section">
            <div class="container pt-100 max-w-600">

                <div class="header-content text-center" style="margin-bottom: 40px;">
                    <h1 class="text-gradient" style="font-size: 2.5rem; margin-bottom: 16px;">Configure Addon</h1>
                    <p class="hero-subtitle">
                        To skip intros, IntroHater needs your debrid service API key.
                    </p>
                    <button type="button" id="openGuideBtn" class="btn btn-guide" style="margin-top: 16px;">
                        üìñ Setup Guide
                    </button>
                </div>

                <div class="glass-panel p-40">

                    <form id="config-form">
                        <div class="form-group">
                            <label class="form-label" for="provider">Primary Debrid Provider</label>
                            <select id="provider" class="form-input" style="margin-bottom: 16px;">
                                <option value="realdebrid">Real-Debrid</option>
                                <option value="torbox">TorBox</option>
                                <option value="premiumize">Premiumize</option>
                                <option value="alldebrid">AllDebrid</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="debridKey">API Key</label>
                            <div class="flex gap-10 mb-8">
                                <input type="text" id="debridKey" class="form-input" placeholder="Paste your key here"
                                    required>
                                <a id="getKeyLink" href="https://real-debrid.com/apitoken" target="_blank"
                                    class="btn btn-secondary nowrap">
                                    Get Key ‚Üó
                                </a>
                            </div>
                            <div class="flex gap-10 mt-10">
                                <a href="profile.html" class="btn btn-secondary flex-1 justify-center">View My
                                    Profile</a>
                                <button type="button" id="logoutBtn"
                                    class="btn btn-danger-outline d-none flex-1">Logout</button>
                            </div>
                        </div>

                        <!-- Secondary Providers Section -->
                        <div id="secondary-providers-container" class="mt-20"></div>

                        <button type="button" id="addSecondaryBtn" class="btn btn-secondary w-full justify-center mt-16"
                            style="border-style: dashed;">
                            ‚ûï Add Secondary Provider
                        </button>
                        <p class="text-sm mt-8 text-center" style="color: var(--text-dim); font-size: 0.75rem;">
                            Use this if your AIOstreams is configured with multiple debrid services (e.g., TorBox +
                            Real-Debrid)
                        </p>


                        <div class="form-group mb-24 mt-24">
                            <label class="form-label" for="externalScraper">üåê Stream Source (Required)</label>
                            <input type="text" id="externalScraper" class="form-input"
                                placeholder="https://aiostreams.../manifest.json" required>
                            <div class="text-sm mt-8" style="color: var(--text-muted); font-size: 0.8rem;">
                                <strong>Step 1:</strong> Go to <a
                                    href="https://aiostreams.elfhosted.com/stremio/configure" target="_blank"
                                    style="color: var(--primary);">AIOstreams</a> and configure with your debrid
                                service(s)
                                + Scraper (Comet works great, torrentio is also good but has a lot of downtime).<br>
                                <strong>Step 2:</strong> Copy your AIOstreams manifest URL and paste it above.<br>
                                <div
                                    style="background: rgba(59, 130, 246, 0.15); border-left: 3px solid #3b82f6; padding: 8px 12px; margin-top: 10px; border-radius: 4px;">
                                    <strong style="color: #3b82f6;">‚ÑπÔ∏è Multi-Provider:</strong> If using multiple debrid
                                    services in AIOstreams,
                                    add each provider above. IntroHater will automatically use the correct API key based
                                    on stream source.
                                </div>
                            </div>
                        </div>


                        <div class="mt-20">
                            <button type="submit" class="btn btn-primary w-full justify-center">
                                Generate Install Link
                            </button>
                        </div>
                    </form>



                    <div id="result-section" class="d-none mt-30 pt-30 border-top">

                        <div class="form-group">
                            <label class="form-label">Your Install Link</label>
                            <div class="flex gap-10">
                                <input type="text" id="installLink" class="form-input" readonly>
                                <button id="copyBtn" class="btn btn-secondary">Copy</button>
                            </div>
                        </div>

                        <div class="flex gap-16 mt-20">
                            <a id="installBtn" href="#" class="btn btn-primary flex-1 justify-center">
                                Install on Stremio
                            </a>
                        </div>

                        <p class="text-sm text-center mt-16" style="color: var(--text-muted);">
                            If installation fails, copy the link above and paste it into the Stremio search bar to
                            install manually.
                        </p>
                    </div>

                    <div class="mt-24 pt-24 text-center border-top">
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Want to contribute or check history?
                            <br>
                            Go to the <a href="contribute.html" style="color: var(--primary);">Community Portal</a>.
                        </p>
                    </div>

                </div>


                <div class="mt-24 pt-24 text-center border-top">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        <a href="profile.html" style="color: var(--primary);">My Profile</a> ¬∑
                        <a href="contribute.html" style="color: var(--primary);">Contribute</a> ¬∑
                        <a href="leaderboard.html" style="color: var(--primary);">Leaderboard</a>
                    </p>
                    <p style="color: var(--text-dim); font-size: 0.8rem; margin-top: 12px;">
                        Supports Real-Debrid, TorBox, Premiumize, and AllDebrid.
                    </p>
                </div>

            </div>

            </div>
        </section>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                let secondaryCount = 0;
                const maxSecondary = 3;
                const container = document.getElementById('secondary-providers-container');
                const addBtn = document.getElementById('addSecondaryBtn');

                // Create secondary provider entry
                function createSecondaryEntry(prov = '', key = '') {
                    if (secondaryCount >= maxSecondary) return;
                    secondaryCount++;

                    const id = secondaryCount;
                    const usedProviders = getUsedProviders();

                    const entry = document.createElement('div');
                    entry.className = 'secondary-provider-entry';
                    entry.dataset.id = id;
                    entry.style.cssText = 'background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 16px; margin-bottom: 12px;';

                    // Build options excluding already used providers
                    const providerOptions = Object.entries(DEBRID_PROVIDERS)
                        .filter(([k]) => !usedProviders.includes(k) || k === prov)
                        .map(([k, v]) => `<option value="${k}" ${k === prov ? 'selected' : ''}>${v.name}</option>`)
                        .join('');

                    entry.innerHTML = `
                        <div class="flex gap-10 items-center mb-8">
                            <span style="color: var(--text-muted); font-size: 0.85rem;">Secondary Provider</span>
                            <button type="button" class="remove-secondary-btn" style="margin-left: auto; background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;" title="Remove">&times;</button>
                        </div>
                        <div class="flex gap-10 mb-8">
                            <select class="form-input secondary-provider-select" style="flex: 0 0 140px;">
                                ${providerOptions}
                            </select>
                            <input type="text" class="form-input secondary-key-input" placeholder="API Key" value="${key}">
                            <a href="${DEBRID_PROVIDERS[prov || 'realdebrid']?.keyUrl}" target="_blank" class="btn btn-secondary nowrap secondary-get-key">Get Key ‚Üó</a>
                        </div>
                    `;

                    container.appendChild(entry);

                    // Event: update get key link
                    entry.querySelector('.secondary-provider-select').onchange = function () {
                        const keyUrl = DEBRID_PROVIDERS[this.value]?.keyUrl || '#';
                        entry.querySelector('.secondary-get-key').href = keyUrl;
                    };

                    // Event: remove entry
                    entry.querySelector('.remove-secondary-btn').onclick = function () {
                        entry.remove();
                        secondaryCount--;
                        updateAddButton();
                    };

                    updateAddButton();
                }

                function getUsedProviders() {
                    const used = [document.getElementById('provider').value];
                    document.querySelectorAll('.secondary-provider-select').forEach(sel => {
                        used.push(sel.value);
                    });
                    return used;
                }

                function updateAddButton() {
                    if (secondaryCount >= maxSecondary || getUsedProviders().length >= Object.keys(DEBRID_PROVIDERS).length) {
                        addBtn.style.display = 'none';
                    } else {
                        addBtn.style.display = '';
                    }
                }

                function getSecondaryProviders() {
                    const providers = [];
                    document.querySelectorAll('.secondary-provider-entry').forEach(entry => {
                        const prov = entry.querySelector('.secondary-provider-select')?.value;
                        const key = entry.querySelector('.secondary-key-input')?.value?.trim();
                        if (prov && key) {
                            providers.push({ provider: prov, key });
                        }
                    });
                    return providers;
                }

                // Update Get Key link when primary provider changes
                document.getElementById('provider').onchange = function () {
                    const provider = this.value;
                    const keyUrl = DEBRID_PROVIDERS[provider]?.keyUrl || DEBRID_PROVIDERS.realdebrid.keyUrl;
                    document.getElementById('getKeyLink').href = keyUrl;
                };

                // Add secondary button
                addBtn.onclick = () => createSecondaryEntry();

                // Persistence Logic - load saved config on page load
                (function () {
                    const config = getDebridConfig();
                    const savedProvider = config.provider || 'realdebrid';
                    const savedKey = config.debridKey;
                    const savedScraper = config.externalScraper;
                    const savedProxy = config.proxyUrl;
                    const savedProxyPassword = config.proxyPassword;
                    const savedSecondary = config.secondaryProviders || [];

                    document.getElementById('provider').value = savedProvider;
                    document.getElementById('getKeyLink').href = DEBRID_PROVIDERS[savedProvider]?.keyUrl || DEBRID_PROVIDERS.realdebrid.keyUrl;

                    if (savedKey) {
                        document.getElementById('debridKey').value = savedKey;
                        document.getElementById('logoutBtn').classList.remove('d-none');
                    }
                    if (savedScraper) {
                        document.getElementById('externalScraper').value = savedScraper;
                    }

                    const proxyUrlEl = document.getElementById('proxyUrl');
                    const proxyPasswordEl = document.getElementById('proxyPassword');
                    if (savedProxy && proxyUrlEl) {
                        proxyUrlEl.value = savedProxy;
                    }
                    if (savedProxyPassword && proxyPasswordEl) {
                        proxyPasswordEl.value = savedProxyPassword;
                    }

                    // Load secondary providers
                    savedSecondary.forEach(s => {
                        createSecondaryEntry(s.provider, s.key);
                    });
                })();

                // Generate Install Link Form
                document.getElementById('config-form').onsubmit = function (e) {
                    e.preventDefault();
                    const provider = document.getElementById('provider').value;
                    const key = document.getElementById('debridKey').value.trim();
                    const scraper = document.getElementById('externalScraper').value.trim();
                    const proxyUrlEl = document.getElementById('proxyUrl');
                    const proxyUrl = proxyUrlEl ? proxyUrlEl.value.trim() : '';
                    const proxyPasswordEl = document.getElementById('proxyPassword');
                    const proxyPassword = proxyPasswordEl ? proxyPasswordEl.value.trim() : '';
                    const secondaryProviders = getSecondaryProviders();

                    if (!key) return;

                    // Save to localStorage using helper
                    setDebridConfig(provider, key, {
                        externalScraper: scraper,
                        proxyUrl: proxyUrl,
                        proxyPassword: proxyPassword,
                        secondaryProviders: secondaryProviders
                    });

                    document.getElementById('logoutBtn').classList.remove('d-none');

                    // Build config value: "provider:key[+provider2:key2][:s=BASE64][:p=BASE64][:pp=BASE64]"
                    let configValue = `${provider}:${key}`;

                    // Add secondary providers with + separator
                    secondaryProviders.forEach(s => {
                        configValue += `+${s.provider}:${s.key}`;
                    });

                    // Add optional params
                    if (scraper) {
                        let cleanScraper = scraper.replace(/\/manifest\.json$/, '');
                        configValue += `:s=${btoa(cleanScraper)}`;
                    }
                    if (proxyUrl) {
                        let cleanProxy = proxyUrl.replace(/\/$/, '');
                        configValue += `:p=${btoa(cleanProxy)}`;
                    }
                    if (proxyPassword) {
                        configValue += `:pp=${btoa(proxyPassword)}`;
                    }

                    // Construct Stremio Install URL
                    const protocol = 'stremio:';
                    const host = window.location.host;
                    const installUrl = `${protocol}//${host}/${configValue}/manifest.json`;

                    // Show result
                    document.getElementById('installLink').value = installUrl;
                    document.getElementById('installBtn').href = installUrl;
                    document.getElementById('result-section').classList.remove('d-none');
                };

                // Copy Button
                document.getElementById('copyBtn').onclick = function () {
                    const link = document.getElementById('installLink');
                    link.select();
                    navigator.clipboard.writeText(link.value).then(() => {
                        const btn = this;
                        const originalText = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => btn.textContent = originalText, 2000);
                    });
                };

                // Select link on click
                document.getElementById('installLink').onclick = function () {
                    this.select();
                };
            });
        </script>
    </main>


    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <a href="/" class="logo">IntroHater</a>
                    <p class="footer-tagline">
                        Making streaming better, one skip at a time.
                    </p>
                </div>
                <div class="footer-col">
                    <h4>Product</h4>
                    <ul>
                        <li><a href="catalog.html">Catalog</a></li>
                        <li><a href="leaderboard.html">Leaderboard</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Developers</h4>
                    <ul>
                        <li><a href="https://github.com/introhaterapp/IntroHater">GitHub</a></li>
                        <li><a href="https://github.com/introhaterapp/IntroHater/issues">Report Issue</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="privacy.html">Privacy Policy</a></li>
                        <li><a href="terms.html">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 IntroHater. Open source and community powered.</p>
            </div>
        </div>
    </footer>

    <div id="setupGuideModal" class="setup-guide-modal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <span>üìñ</span>
                    <span>Setup Guide</span>
                </div>
                <button class="modal-close" id="closeGuideBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="carousel">
                    <div class="carousel-track" id="carouselTrack">
                        <div class="carousel-slide">
                            <img src="CopyAioStreamsURL.png" alt="Step 1: Copy AIOstreams URL">
                            <div class="carousel-caption">
                                <span class="step-number">1</span>
                                <span class="step-text">Copy your AIOstreams manifest URL</span>
                                <p class="step-hint">Configure AIOstreams with your debrid service + Scraper (Comet
                                    currently recommended), then
                                    copy the generated URL.</p>
                            </div>
                        </div>
                        <div class="carousel-slide">
                            <img src="PasteAioStreamsURLandAPIKEYtoIntroHaterConfig.png"
                                alt="Step 2: Paste URL and API Key">
                            <div class="carousel-caption">
                                <span class="step-number">2</span>
                                <span class="step-text">Paste URL & API Key into IntroHater</span>
                                <p class="step-hint">Enter your debrid API key and paste the AIOstreams manifest URL in
                                    the form above.</p>
                            </div>
                        </div>
                        <div class="carousel-slide">
                            <img src="InstallIntroHAterTOStremio.png" alt="Step 3: Install to Stremio">
                            <div class="carousel-caption">
                                <span class="step-number">3</span>
                                <span class="step-text">Install IntroHater to Stremio</span>
                                <p class="step-hint">Click "Install on Stremio" to add the addon to your Stremio app.
                                </p>
                            </div>
                        </div>
                        <div class="carousel-slide">
                            <img src="OpenAStreamAndSeeIntroHaterListed.png" alt="Step 4: See IntroHater streams">
                            <div class="carousel-caption">
                                <span class="step-number">4</span>
                                <span class="step-text">Open a show and see IntroHater listed</span>
                                <p class="step-hint">Browse to any TV show or movie - you'll see IntroHater streams in
                                    the list.</p>
                            </div>
                        </div>
                        <div class="carousel-slide">
                            <img src="selectstream-targetmeansskipenabled.png" alt="Step 5: Select stream with skip">
                            <div class="carousel-caption">
                                <span class="step-number">5</span>
                                <span class="step-text">Select a stream with the üéØ icon</span>
                                <p class="step-hint">The üéØ icon means intro skip is available! Select it and enjoy
                                    auto-skipped intros.</p>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-controls">
                        <button class="carousel-btn" id="prevBtn" disabled>‚Üê</button>
                        <div class="carousel-dots" id="carouselDots"></div>
                        <button class="carousel-btn" id="nextBtn">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const modal = document.getElementById('setupGuideModal');
            const openBtn = document.getElementById('openGuideBtn');
            const closeBtn = document.getElementById('closeGuideBtn');
            const track = document.getElementById('carouselTrack');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const dotsContainer = document.getElementById('carouselDots');
            const slides = track.children;
            const totalSlides = slides.length;
            let currentSlide = 0;

            for (let i = 0; i < totalSlides; i++) {
                const dot = document.createElement('button');
                dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
                dot.addEventListener('click', () => goToSlide(i));
                dotsContainer.appendChild(dot);
            }
            const dots = dotsContainer.children;

            function goToSlide(index) {
                currentSlide = index;
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
                prevBtn.disabled = currentSlide === 0;
                nextBtn.disabled = currentSlide === totalSlides - 1;
                Array.from(dots).forEach((dot, i) => {
                    dot.classList.toggle('active', i === currentSlide);
                });
            }

            prevBtn.addEventListener('click', () => {
                if (currentSlide > 0) goToSlide(currentSlide - 1);
            });

            nextBtn.addEventListener('click', () => {
                if (currentSlide < totalSlides - 1) goToSlide(currentSlide + 1);
            });

            openBtn.addEventListener('click', () => {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            closeBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!modal.classList.contains('active')) return;
                if (e.key === 'Escape') {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                } else if (e.key === 'ArrowLeft') {
                    if (currentSlide > 0) goToSlide(currentSlide - 1);
                } else if (e.key === 'ArrowRight') {
                    if (currentSlide < totalSlides - 1) goToSlide(currentSlide + 1);
                }
            });
        })();
    </script>
</body>

</html>
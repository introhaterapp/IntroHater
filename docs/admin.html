<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntroHater - Admin Moderation</title>
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css?v=2">
    <style>
        .active-filter {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
            color: white !important;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .mod-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .mod-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 16px !important;
            }

            .mod-header h1 {
                font-size: 1.5rem !important;
            }

            .mod-filter-bar {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            .mod-filter-bar>div {
                width: 100% !important;
                min-width: unset !important;
            }

            #filterChips {
                flex-wrap: wrap !important;
            }

            .mod-section-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 12px !important;
            }

            .mod-section-header>div {
                width: 100% !important;
            }

            .mod-section-header .btn {
                flex: 1 !important;
            }

            .mod-item-actions {
                flex-direction: column !important;
            }

            .mod-item-actions .btn {
                width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <a href="/" class="logo text-gradient">
                <img src="/icon.svg" alt="Logo"> IntroHater Admin
            </a>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="catalog.html">Catalog</a></li>
                    <li><a href="leaderboard.html">Leaderboard</a></li>
                    <li><a href="contribute.html">Contribute</a></li>
                    <li><a href="profile.html">Profile</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section class="section">
            <div class="container" style="padding-top: 100px;">

                <div id="login-panel" class="glass-panel" style="max-width: 400px; margin: 0 auto; padding: 40px;">
                    <h2 class="text-center" style="margin-bottom: 20px;">Admin Login</h2>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="adminPass" class="form-input" placeholder="Enter Admin Password">
                    </div>
                    <button id="loginBtn" class="btn btn-primary"
                        style="width: 100%; justify-content: center; margin-top: 10px;">Login</button>
                </div>

                <div id="mod-panel" class="d-none">
                    <div class="mod-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 class="text-gradient">Moderation Queue</h1>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div id="queue-stats"
                                style="font-size: 0.85rem; color: var(--text-muted); padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                Pending: <span id="pending-count"
                                    style="color: var(--primary); font-weight: 600;">0</span> |
                                Reported: <span id="reported-count" style="color: #ef4444; font-weight: 600;">0</span>
                            </div>
                            <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
                        </div>
                    </div>

                    <!-- Search and Filter Bar -->
                    <div class="glass-panel mod-filter-bar"
                        style="padding: 16px; margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 16px; align-items: center;">
                        <div style="flex: 1; min-width: 250px;">
                            <input type="text" id="modSearch" class="form-input"
                                placeholder="Search by Title or IMDB ID..." style="margin: 0;">
                        </div>
                        <div style="display: flex; gap: 8px;" id="filterChips">
                            <button class="btn btn-sm btn-secondary active-filter" data-filter="all">All</button>
                            <button class="btn btn-sm btn-secondary" data-filter="intro">Intros</button>
                            <button class="btn btn-sm btn-secondary" data-filter="outro">Outros</button>
                            <button class="btn btn-sm btn-secondary" data-filter="credits">Credits</button>
                        </div>
                        <div>
                            <select id="modSort" class="form-input"
                                style="margin: 0; padding: 6px 12px; font-size: 0.85rem; width: auto;">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="reported">Most Reported</option>
                            </select>
                        </div>
                    </div>

                    <div class="mod-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <div class="mod-section-header"
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">Pending Submissions</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button id="selectAllBtn" class="btn btn-sm btn-secondary">Select All</button>
                                    <button id="bulkApproveBtn" class="btn btn-sm btn-primary">Approve</button>
                                    <button id="bulkDeleteBtn" class="btn btn-sm btn-secondary"
                                        style="background:#ef4444; border-color:#ef4444;">Delete</button>
                                </div>
                            </div>
                            <div id="pending-list" style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Items -->
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 20px;">Reported Skips</h3>
                            <div id="report-list" style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Items -->
                            </div>
                        </div>
                    </div>

                    <!-- IntroDB Indexer Section -->
                    <div class="glass-panel" style="margin-top: 30px; padding: 24px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">ðŸ”„ IntroDB Indexer</h3>
                            <div style="display: flex; gap: 10px;">
                                <button id="indexerStatusBtn" class="btn btn-secondary"
                                    style="font-size: 0.85rem;">Refresh Status</button>
                                <button id="triggerIndexerBtn" class="btn btn-primary" style="font-size: 0.85rem;">Run
                                    Indexer</button>
                                <button id="resetIndexerBtn" class="btn btn-secondary"
                                    style="font-size: 0.85rem; background: #ef4444; border-color: #ef4444;">Reset
                                    Progress</button>
                            </div>
                        </div>

                        <div id="indexer-stats"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                            <div
                                style="text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--primary);"
                                    id="stat-segments">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Segments Imported</div>
                            </div>
                            <div
                                style="text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #22c55e;" id="stat-episodes">0
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Episodes Checked</div>
                            </div>
                            <div
                                style="text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;" id="stat-shows">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Shows Processed</div>
                            </div>
                            <div
                                style="text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;" id="stat-with-data">0
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Shows with Data</div>
                            </div>
                        </div>

                        <div
                            style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted);">
                                <span>Status: <span id="indexer-status" style="color: #22c55e;">Idle</span></span>
                                <span>Last Cycle: <span id="stat-cycle">0</span> segments</span>
                                <span>Last Run: <span id="stat-lastrun">Never</span></span>
                            </div>
                        </div>

                        <div style="margin-top: 16px;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Recently
                                Checked Shows:</div>
                            <div id="recent-shows"
                                style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 0.75rem;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        let adminPass = "";
        let pendingItemsRef = []; // Keep track of rendered items to map checkboxes back to data
        let rawPending = [];
        let rawReported = [];
        let currentFilter = 'all';
        let currentSort = 'newest';
        let currentSearch = '';

        document.getElementById('loginBtn').addEventListener('click', async function () {
            adminPass = document.getElementById('adminPass').value.trim();
            if (!adminPass) return;
            loadQueue();
        });

        // Bulk Actions Event Listeners
        document.getElementById('selectAllBtn').addEventListener('click', () => toggleSelectAll('pending-list'));
        document.getElementById('bulkApproveBtn').addEventListener('click', () => bulkResolve('approve'));
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkResolve('delete'));

        document.getElementById('refreshBtn').addEventListener('click', loadQueue);

        // Search & Filter Listeners
        document.getElementById('modSearch').addEventListener('input', (e) => {
            currentSearch = e.target.value.toLowerCase();
            applyFilters();
        });

        document.getElementById('modSort').addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFilters();
        });

        document.querySelectorAll('#filterChips button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#filterChips button').forEach(b => b.classList.remove('active-filter', 'btn-primary'));
                document.querySelectorAll('#filterChips button').forEach(b => b.classList.add('btn-secondary'));

                btn.classList.add('active-filter', 'btn-primary');
                btn.classList.remove('btn-secondary');

                currentFilter = btn.dataset.filter;
                applyFilters();
            });
        });

        async function loadQueue() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = '...';

            try {
                const res = await fetch('/api/admin/pending', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass })
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('login-panel').style.display = 'none';
                    document.getElementById('mod-panel').classList.remove('d-none');
                    document.getElementById('mod-panel').style.display = 'block';

                    rawPending = data.pending;
                    rawReported = data.reported;

                    document.getElementById('pending-count').textContent = rawPending.length;
                    document.getElementById('reported-count').textContent = rawReported.length;

                    applyFilters();
                } else {
                    alert("Wrong password!");
                }
            } catch (e) {
                console.error(e);
            } finally {
                btn.textContent = 'Refresh';
            }
        }

        function applyFilters() {
            let filteredPending = [...rawPending];
            let filteredReported = [...rawReported];

            const filterFn = (item) => {
                const matchSearch = !currentSearch ||
                    (item.displayTitle && item.displayTitle.toLowerCase().includes(currentSearch)) ||
                    (item.fullId && item.fullId.toLowerCase().includes(currentSearch));

                const matchType = currentFilter === 'all' ||
                    (item.label && item.label.toLowerCase().includes(currentFilter));

                return matchSearch && matchType;
            };

            filteredPending = filteredPending.filter(filterFn);
            filteredReported = filteredReported.filter(filterFn);

            const sortFn = (a, b) => {
                if (currentSort === 'newest') return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
                if (currentSort === 'oldest') return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
                if (currentSort === 'reported') return (b.reportCount || 0) - (a.reportCount || 0);
                return 0;
            };

            filteredPending.sort(sortFn);
            filteredReported.sort(sortFn);

            pendingItemsRef = filteredPending;
            renderList('pending-list', filteredPending, true);
            renderList('report-list', filteredReported, false);
        }

        function renderList(targetId, items, isPending) {
            const cont = document.getElementById(targetId);
            cont.innerHTML = '';

            if (items.length === 0) {
                cont.innerHTML = '<p style="color:var(--text-muted); font-size:0.9rem;">No items found.</p>';
                return;
            }

            items.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = 'glass-panel';
                row.style.padding = '15px';
                row.style.display = 'flex';
                row.style.gap = '15px';
                row.style.alignItems = 'start';

                // Checkbox for pending items
                const checkboxHtml = isPending ? `<input type="checkbox" class="bulk-check" data-idx="${i}" style="margin-top: 5px; transform: scale(1.2);">` : '';

                row.innerHTML = `
                    ${checkboxHtml}
                    <div style="flex: 1;">
                        <div style="margin-bottom: 10px;">
                            <strong style="color:var(--primary); font-size: 1.1rem;">${item.displayTitle || item.fullId}</strong>
                             <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">ID: ${item.fullId}</div>
                            ${item.seriesSkip ? '<span style="background:#f59e0b; color:black; font-size:0.65rem; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:8px; vertical-align:middle;">GLOBAL SERIES SKIP</span>' : ''}
                            <div style="font-size: 0.9rem; margin-top: 8px;">${item.start}s - ${item.end}s <span style="opacity:0.7">(${item.label})</span></div>
                             <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                 Source: <span style="color: #ccc;">${item.source || 'User'}</span> 
                                 ${item.contributors ? `| Contributors: ${item.contributors.join(', ')}` : ''}
                            </div>
                            ${!isPending ? `<div style="color:#ef4444; font-size:0.75rem;">Reports: ${item.reportCount}</div>` : ''}
                        </div>
                        <div class="mod-item-actions" style="display: flex; gap: 10px;">
                            <button class="btn btn-primary mod-approve" style="flex:1; font-size:0.75rem;" data-fullid="${item.fullId}" data-index="${item.index}">${isPending ? 'Approve' : 'Dismiss Reports'}</button>
                            <button class="btn btn-secondary mod-delete" style="flex:1; font-size:0.75rem; background:#ef4444; border-color:#ef4444;" data-fullid="${item.fullId}" data-index="${item.index}">${isPending ? 'Delete' : 'Remove Skip'}</button>
                        </div>
                    </div>
                `;

                // Use simple closure or event delegation? Closure is easier here since we create elements.
                // BUT inline onclick is banned. So we must addEventListener.
                row.querySelector('.mod-approve').addEventListener('click', () => resolve(item.fullId, item.index, 'approve'));
                row.querySelector('.mod-delete').addEventListener('click', () => resolve(item.fullId, item.index, 'delete'));

                cont.appendChild(row);
            });
        }

        async function resolve(fullId, index, action) {
            // if (!confirm(`Are you sure you want to ${action} this?`)) return; // Remove confirm for speed

            try {
                const res = await fetch('/api/admin/resolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass, fullId, index, action })
                });

                if (res.ok) {
                    loadQueue();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function toggleSelectAll(listId) {
            const checks = document.querySelectorAll(`#${listId} .bulk-check`);
            const firstState = checks.length > 0 ? checks[0].checked : false;
            checks.forEach(c => c.checked = !firstState);
        }

        async function bulkResolve(action) {
            const checks = document.querySelectorAll('#pending-list .bulk-check:checked');
            if (checks.length === 0) return alert("No items selected");

            if (!confirm(`Bulk ${action} ${checks.length} items?`)) return;

            const items = [];
            checks.forEach(c => {
                const idx = parseInt(c.dataset.idx);
                const item = pendingItemsRef[idx];
                if (item) {
                    items.push({ fullId: item.fullId, index: item.index });
                }
            });

            try {
                const res = await fetch('/api/admin/resolve-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass, items, action })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`Successfully processed ${data.count} items.`);
                    loadQueue();
                } else {
                    alert("Bulk action failed.");
                }
            } catch (e) {
                console.error(e);
                alert("Error during bulk action");
            }
        }

        // ========== IntroDB Indexer Functions ==========

        document.getElementById('indexerStatusBtn').addEventListener('click', loadIndexerStatus);
        document.getElementById('triggerIndexerBtn').addEventListener('click', triggerIndexer);
        document.getElementById('resetIndexerBtn').addEventListener('click', resetIndexer);

        async function loadIndexerStatus() {
            const btn = document.getElementById('indexerStatusBtn');
            btn.textContent = '...';

            try {
                const res = await fetch('/api/admin/indexer/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass })
                });

                if (res.ok) {
                    const data = await res.json();

                    // Update stats
                    document.getElementById('stat-segments').textContent = (data.stats?.totalSegmentsImported || 0).toLocaleString();
                    document.getElementById('stat-episodes').textContent = (data.stats?.totalEpisodesChecked || 0).toLocaleString();
                    document.getElementById('stat-shows').textContent = (data.checkedShowsCount || 0).toLocaleString();
                    document.getElementById('stat-with-data').textContent = (data.stats?.showsWithData || 0).toLocaleString();
                    document.getElementById('stat-cycle').textContent = data.stats?.lastCycleSegments || 0;

                    // Update status
                    const statusEl = document.getElementById('indexer-status');
                    if (data.isRunning) {
                        statusEl.textContent = 'Running...';
                        statusEl.style.color = '#f59e0b';
                    } else {
                        statusEl.textContent = 'Idle';
                        statusEl.style.color = '#22c55e';
                    }

                    // Update last run
                    if (data.lastRun) {
                        const date = new Date(data.lastRun);
                        document.getElementById('stat-lastrun').textContent = date.toLocaleString();
                    }

                    // Update recent shows
                    const recentContainer = document.getElementById('recent-shows');
                    recentContainer.innerHTML = '';
                    if (data.recentlyChecked && data.recentlyChecked.length > 0) {
                        data.recentlyChecked.forEach(id => {
                            const chip = document.createElement('span');
                            chip.style.cssText = 'background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; color: #ccc;';
                            chip.textContent = id;
                            recentContainer.appendChild(chip);
                        });
                    } else {
                        recentContainer.innerHTML = '<span style="color: #666;">No shows checked yet</span>';
                    }
                }
            } catch (e) {
                console.error('Failed to load indexer status:', e);
            } finally {
                btn.textContent = 'Refresh Status';
            }
        }

        async function triggerIndexer() {
            if (!confirm('Start IntroDB indexer? This will process 50 shows in the background.')) return;

            const btn = document.getElementById('triggerIndexerBtn');
            btn.textContent = 'Starting...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/admin/indexer/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(data.message);
                    loadIndexerStatus();
                } else {
                    const err = await res.json();
                    alert('Failed: ' + (err.message || err.error));
                }
            } catch (e) {
                console.error('Failed to trigger indexer:', e);
                alert('Error triggering indexer');
            } finally {
                btn.textContent = 'Run Indexer';
                btn.disabled = false;
            }
        }

        async function resetIndexer() {
            if (!confirm('Reset indexer progress? This will clear all checked shows and start over from scratch.')) return;

            try {
                const res = await fetch('/api/admin/indexer/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(data.message);
                    loadIndexerStatus();
                } else {
                    alert('Failed to reset indexer');
                }
            } catch (e) {
                console.error('Failed to reset indexer:', e);
                alert('Error resetting indexer');
            }
        }

        // Load indexer status after login
        const originalLoadQueue = loadQueue;
        loadQueue = async function () {
            await originalLoadQueue.call(this);
            loadIndexerStatus();
        };
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntroHater - Admin Moderation</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/icon32.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css?v=2">
</head>

<body>
    <header>
        <div class="container">
            <a href="/" class="logo text-gradient">
                <img src="/icon32.png" alt="Logo"> IntroHater Admin
            </a>
        </div>
    </header>

    <main>
        <section class="section">
            <div class="container" style="padding-top: 100px;">

                <div id="login-panel" class="glass-panel" style="max-width: 400px; margin: 0 auto; padding: 40px;">
                    <h2 class="text-center" style="margin-bottom: 20px;">Admin Login</h2>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="adminPass" class="form-input" placeholder="Enter Admin Password">
                    </div>
                    <button id="loginBtn" class="btn btn-primary"
                        style="width: 100%; justify-content: center; margin-top: 10px;">Login</button>
                </div>

                <div id="mod-panel" class="d-none">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 class="text-gradient">Moderation Queue</h1>
                        <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0;">Pending Submissions</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button id="selectAllBtn" class="btn btn-sm btn-secondary">Select All</button>
                                    <button id="bulkApproveBtn" class="btn btn-sm btn-primary">Approve</button>
                                    <button id="bulkDeleteBtn" class="btn btn-sm btn-secondary"
                                        style="background:#ef4444; border-color:#ef4444;">Delete</button>
                                </div>
                            </div>
                            <div id="pending-list" style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Items -->
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 20px;">Reported Skips</h3>
                            <div id="report-list" style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Items -->
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <script>
        let adminPass = "";
        let pendingItemsRef = []; // Keep track of rendered items to map checkboxes back to data

        document.getElementById('loginBtn').addEventListener('click', async function () {
            adminPass = document.getElementById('adminPass').value.trim();
            if (!adminPass) return;
            loadQueue();
        });

        // Bulk Actions Event Listeners
        document.getElementById('selectAllBtn').addEventListener('click', () => toggleSelectAll('pending-list'));
        document.getElementById('bulkApproveBtn').addEventListener('click', () => bulkResolve('approve'));
        document.getElementById('bulkDeleteBtn').addEventListener('click', () => bulkResolve('delete'));

        document.getElementById('refreshBtn').addEventListener('click', loadQueue);

        async function loadQueue() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = '...';

            try {
                const res = await fetch('/api/admin/pending', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass })
                });

                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('login-panel').style.display = 'none';
                    document.getElementById('mod-panel').classList.remove('d-none');
                    document.getElementById('mod-panel').style.display = 'block';

                    pendingItemsRef = data.pending; // Store for bulk actions
                    renderList('pending-list', data.pending, true);
                    renderList('report-list', data.reported, false);
                } else {
                    alert("Wrong password!");
                }
            } catch (e) {
                console.error(e);
            } finally {
                btn.textContent = 'Refresh';
            }
        }

        function renderList(targetId, items, isPending) {
            const cont = document.getElementById(targetId);
            cont.innerHTML = '';

            if (items.length === 0) {
                cont.innerHTML = '<p style="color:var(--text-muted); font-size:0.9rem;">No items found.</p>';
                return;
            }

            items.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = 'glass-panel';
                row.style.padding = '15px';
                row.style.display = 'flex';
                row.style.gap = '15px';
                row.style.alignItems = 'start';

                // Checkbox for pending items
                const checkboxHtml = isPending ? `<input type="checkbox" class="bulk-check" data-idx="${i}" style="margin-top: 5px; transform: scale(1.2);">` : '';

                row.innerHTML = `
                    ${checkboxHtml}
                    <div style="flex: 1;">
                        <div style="margin-bottom: 10px;">
                            <strong style="color:var(--primary); font-size: 1.1rem;">${item.displayTitle || item.fullId}</strong>
                             <div style="font-size: 0.75rem; color: #888; margin-top: 4px;">ID: ${item.fullId}</div>
                            ${item.seriesSkip ? '<span style="background:#f59e0b; color:black; font-size:0.65rem; padding:2px 6px; border-radius:4px; font-weight:700; margin-left:8px; vertical-align:middle;">GLOBAL SERIES SKIP</span>' : ''}
                            <div style="font-size: 0.9rem; margin-top: 8px;">${item.start}s - ${item.end}s <span style="opacity:0.7">(${item.label})</span></div>
                             <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                 Source: <span style="color: #ccc;">${item.source || 'User'}</span> 
                                 ${item.contributors ? `| Contributors: ${item.contributors.join(', ')}` : ''}
                            </div>
                            ${!isPending ? `<div style="color:#ef4444; font-size:0.75rem;">Reports: ${item.reportCount}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary mod-approve" style="flex:1; font-size:0.75rem;" data-fullid="${item.fullId}" data-index="${item.index}">Approve</button>
                            <button class="btn btn-secondary mod-delete" style="flex:1; font-size:0.75rem; background:#ef4444; border-color:#ef4444;" data-fullid="${item.fullId}" data-index="${item.index}">Delete</button>
                        </div>
                    </div>
                `;

                // Use simple closure or event delegation? Closure is easier here since we create elements.
                // BUT inline onclick is banned. So we must addEventListener.
                row.querySelector('.mod-approve').addEventListener('click', () => resolve(item.fullId, item.index, 'approve'));
                row.querySelector('.mod-delete').addEventListener('click', () => resolve(item.fullId, item.index, 'delete'));

                cont.appendChild(row);
            });
        }

        async function resolve(fullId, index, action) {
            // if (!confirm(`Are you sure you want to ${action} this?`)) return; // Remove confirm for speed

            try {
                const res = await fetch('/api/admin/resolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass, fullId, index, action })
                });

                if (res.ok) {
                    loadQueue();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function toggleSelectAll(listId) {
            const checks = document.querySelectorAll(`#${listId} .bulk-check`);
            const firstState = checks.length > 0 ? checks[0].checked : false;
            checks.forEach(c => c.checked = !firstState);
        }

        async function bulkResolve(action) {
            const checks = document.querySelectorAll('#pending-list .bulk-check:checked');
            if (checks.length === 0) return alert("No items selected");

            if (!confirm(`Bulk ${action} ${checks.length} items?`)) return;

            const items = [];
            checks.forEach(c => {
                const idx = parseInt(c.dataset.idx);
                const item = pendingItemsRef[idx];
                if (item) {
                    items.push({ fullId: item.fullId, index: item.index });
                }
            });

            try {
                const res = await fetch('/api/admin/resolve-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPass, items, action })
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`Successfully processed ${data.count} items.`);
                    loadQueue();
                } else {
                    alert("Bulk action failed.");
                }
            } catch (e) {
                console.error(e);
                alert("Error during bulk action");
            }
        }
    </script>
</body>

</html>